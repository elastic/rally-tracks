{% set is_esql_profiling_enabled = (esql_profiling_enabled | default(true)) %}
{
  "operation": {
    "operation-type": "delete-index"
  }
},
{
  "name": "create-index",
  "operation": "create-index"
},
{
  "name": "check-cluster-health",
  "operation": "check-cluster-health"
},
{
  "name": "initial-documents-indexing",
  "operation": "initial-documents-indexing",
  "warmup-time-period": {{ initial_indexing_bulk_warmup | default(40) | int }},
  "clients": {{ initial_indexing_bulk_indexing_clients | default(5) | int }}
},
{
  "name": "refresh-after-index",
  "operation": {
    "operation-type": "refresh",
    "request-timeout": 1000,
    "include-in-reporting": true
  }
},
{
  "name": "wait-until-merges-finish-after-index",
  "operation": {
    "operation-type": "index-stats",
    "index": "_all",
    "condition": {
      "path": "_all.total.merges.current",
      "expected-value": 0
    },
    "retry-until-success": true,
    "include-in-reporting": false
  }
}
{# serverless-post-ingest-sleep-marker-start #}{%- if post_ingest_sleep|default(false) -%},
{
  "name": "post-ingest-sleep",
  "operation": {
    "operation-type": "sleep",
    "duration": {{ post_ingest_sleep_duration|default(30) }}
  }
}
{%- endif -%}{# serverless-post-ingest-sleep-marker-end #}

{%- set p_hybrid_knn_ops = (hybrid_knn_ops | default([(10, 0), (10, 50), (100, 200), (100, 300)]) ) -%}
{%- set client_opts = ["single-client", "multiple-clients"] -%}

{%- for clients in client_opts -%}
{%- for i in range(p_hybrid_knn_ops|length) -%},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}",
    "operation": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}"
  {%- else -%}
    "name": "hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}",
    "operation": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}"
  {%- endif -%},
  "warmup-iterations": 1000,
  "iterations": {{ standalone_search_iterations | default(10000) | int }}
  {%- if clients == "multiple-clients" -%},
  "clients": {{ standalone_search_clients | default(8) | int }}
  {%- endif -%}
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "esql-hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}",
    "operation": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}"
  {%- else -%}
    "name": "esql-hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}",
    "operation": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}"
  {%- endif -%},
  "warmup-iterations": 1000,
  "iterations": {{ standalone_search_iterations | default(10000) | int }}
  {%- if clients == "multiple-clients" -%},
  "clients": {{ standalone_search_clients | default(8) | int }}
  {%- endif -%}
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source",
    "operation": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source"
  {%- else -%}
    "name": "hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-source",
    "operation": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-source"
  {%- endif -%},
  "warmup-iterations": 1000,
  "iterations": {{ standalone_search_iterations | default(10000) | int }}
  {%- if clients == "multiple-clients" -%},
  "clients": {{ standalone_search_clients | default(8) | int }}
  {%- endif -%}
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "esql-hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source",
    "operation": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source"
  {%- else -%}
    "name": "esql-hybrid-search-{{clients}}-{{p_hybrid_knn_ops[i][0]}}-source",
    "operation": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-source"
  {%- endif -%},
  "warmup-iterations": 1000,
  "iterations": {{ standalone_search_iterations | default(10000) | int }}
  {%- if clients == "multiple-clients" -%},
  "clients": {{ standalone_search_clients | default(8) | int }}
  {%- endif -%}
}
{%- endfor -%}
{%- endfor -%}
{% if is_esql_profiling_enabled %},
{
"name": "esql-profile-hybrid-search-single-client",
"operation": "esql-profile-hybrid-search-bm25-knn",
"warmup-iterations": 1000,
"iterations": {{ standalone_search_iterations | default(10000) | int }}
},
{
"name": "esql-profile-hybrid-search-bm25-knn-multiple-clients",
"operation": "esql-profile-hybrid-search-bm25-knn",
"warmup-iterations": 1000,
"iterations": {{ standalone_search_iterations | default(10000) | int }},
"clients": {{ standalone_search_clients | default(8) | int }}
}
{% endif %}
