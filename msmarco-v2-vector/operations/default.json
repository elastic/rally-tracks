{% set p_corpora = (corpora | default(["msmarco-v2_float-initial-indexing-1", "msmarco-v2_float-initial-indexing-2", "msmarco-v2_float-initial-indexing-3", "msmarco-v2_float-initial-indexing-4", "msmarco-v2_float-initial-indexing-5", "msmarco-v2_float-initial-indexing-6", "msmarco-v2_float-initial-indexing-7", "msmarco-v2_float-initial-indexing-8"])) %}
{
  "name": "create-index",
  "operation-type": "create-index",
  "settings": {{index_settings | default({}) | tojson}}
},
{
  "name": "check-cluster-health",
  "operation-type": "cluster-health",
  "request-params": {
    "wait_for_status": "green"
  },
  "retry-until-success": true
},
{
  "name": "initial-documents-indexing",
  "operation-type": "bulk",
  "corpora":  [
    {% for doc_id in p_corpora %}
       {{doc_id | tojson}}
       {{ ", " if not loop.last else "" }}
   {% endfor %}],
  "bulk-size": {{initial_indexing_bulk_size | default(500)}},
  {%- if initial_indexing_ingest_doc_count is defined %}
  "ingest-doc-count": {{ initial_indexing_ingest_doc_count }}
  {%- else %}
  "ingest-percentage": {{initial_indexing_ingest_percentage | default(100)}}
  {%- endif %}   
},
{
  "name": "parallel-documents-indexing",
  "operation-type": "bulk",
  "corpora": {{parallel_corpora | default("msmarco-v2_float-parallel-indexing") | tojson }},
  "bulk-size": {{parallel_indexing_bulk_size | default(50)}},
  "ingest-percentage": {{parallel_indexing_ingest_percentage | default(100)}}
}
{%- set p_search_ops = (search_ops | default([(10, 20, 0), (10, 20, 1), (10, 50, 0), (10, 50, 2), (10, 100, 0), (10, 100, 2), (10, 200, 0), (10, 200, 2), (10, 500, 0), (10, 500, 2), (10, 1000, 0), (10, 1000, 2), (100, 120, 0), (100, 120, 1), (100, 200, 0), (100, 200, 1), (100, 500, 0), (100, 500, 120), (100, 1000, 0), (100, 1000, 120)]))%}
{%- for i in range(p_search_ops|length) %},
{
  {%- if p_search_ops[i][2] > 0 -%}
    "name": "knn-search-{{p_search_ops[i][0]}}-{{p_search_ops[i][1]}}-{{p_search_ops[i][2]}}"
  {%- else -%}
    "name": "knn-search-{{p_search_ops[i][0]}}-{{p_search_ops[i][1]}}"
  {%- endif -%},
  "operation-type": "search",
  "param-source": "knn-param-source",
  "k": {{p_search_ops[i][0]}},
  "num-candidates": {{p_search_ops[i][1]}},
  "oversample-rescore": {{p_search_ops[i][2]}}
},
{
  {%- if p_search_ops[i][2] > 0 -%}
    "name": "knn-recall-{{p_search_ops[i][0]}}-{{p_search_ops[i][1]}}-{{p_search_ops[i][2]}}"
  {%- else -%}
    "name": "knn-recall-{{p_search_ops[i][0]}}-{{p_search_ops[i][1]}}"
  {%- endif -%},
  "operation-type": "knn-recall",
  "param-source": "knn-recall-param-source",
  "k": {{p_search_ops[i][0]}},
  "num-candidates": {{p_search_ops[i][1]}},
  "oversample-rescore": {{p_search_ops[i][2]}},
  "include-in-reporting": false
}
{%- endfor %}
{%- set p_hybrid_knn_ops = (hybrid_knn_ops | default([(10, 0), (10, 50), (100, 200), (100, 300)]) ) -%}
{%- for i in range(p_hybrid_knn_ops|length) -%},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}"
  {%- else -%}
    "name": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}"
  {%- endif -%},
  "operation-type": "search",
  "param-source": "hybrid-bm25-knn-param-source",
  "size": {{p_hybrid_knn_ops[i][0]}},
  "k": {{p_hybrid_knn_ops[i][0]}}
  {%- if p_hybrid_knn_ops[i][1] > 0 -%},
  "num-candidates": {{p_hybrid_knn_ops[i][1]}}
  {%- endif -%}
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source"
  {%- else -%}
    "name": "hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-source"
  {%- endif -%},
  "operation-type": "search",
  "param-source": "hybrid-bm25-knn-param-source",
  "size": {{p_hybrid_knn_ops[i][0]}},
  "k": {{p_hybrid_knn_ops[i][0]}}
  {%- if p_hybrid_knn_ops[i][1] > 0 -%},
  "num-candidates": {{p_hybrid_knn_ops[i][1]}}
  {%- endif -%},
  "source": true
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
  "name": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}"
  {%- else -%}
  "name": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}"
  {%- endif -%},
  "operation-type": "esql",
  "param-source": "esql-hybrid-bm25-knn-param-source",
  "size": {{p_hybrid_knn_ops[i][0]}},
  "k": {{p_hybrid_knn_ops[i][0]}}
  {%- if p_hybrid_knn_ops[i][1] > 0 -%},
  "num-candidates": {{p_hybrid_knn_ops[i][1]}}
  {%- endif -%}
},
{
  {%- if p_hybrid_knn_ops[i][1] > 0 -%}
    "name": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-{{p_hybrid_knn_ops[i][1]}}-source"
  {%- else -%}
    "name": "esql-hybrid-search-bm25-knn-{{p_hybrid_knn_ops[i][0]}}-source"
  {%- endif -%},
  "operation-type": "esql",
  "param-source": "esql-hybrid-bm25-knn-param-source",
  "size": {{p_hybrid_knn_ops[i][0]}},
  "k": {{p_hybrid_knn_ops[i][0]}}
  {%- if p_hybrid_knn_ops[i][1] > 0 -%},
  "num-candidates": {{p_hybrid_knn_ops[i][1]}}
  {%- endif -%},
  "keep-all": true
}
{%- endfor -%},
{
"name": "esql-profile-hybrid-search-bm25-knn",
"operation-type": "esql-profile",
"param-source": "esql-hybrid-bm25-knn-param-source",
"size": 100,
"k": 100,
"num-candidates": 200
}
