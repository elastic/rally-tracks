{%- if ingest_mode is defined and ingest_mode == "data_stream" %}
    {%- set p_index_source = 'gharchive' %}
{%- else %}
    {%- set p_index_source = 'github-archive' %}
{%- endif %}
{%- set p_conflicts = conflicts %}
{%- set p_conflict_probability = conflict_probability | default(25) %}
{%- set p_on_conflict = on_conflict | default('index') %}
{
  "name": "index",
  "operation-type": "bulk",
  "bulk-size": {{bulk_size | default(5000)}},
  "ingest-percentage": {{ingest_percentage | default(100)}}
  {%- if conflicts is defined %},
  "conflicts": "{{p_conflicts}}",
  "on-conflict": "{{p_on_conflict}}",
  "conflict-probability": {{p_conflict_probability}}
  {%- endif %}
},
{
  "name": "default",
  "operation-type": "search",
  "body": {
    "query": {
      "match_all": {}
    }
  }
},
{
  "name": "default_1k",
  "operation-type": "search",
  "body": {
    "query": {
      "match_all": {}
    },
    "size": 1000
  }
},
{
  "name": "async-search-aggs",
  "operation-type": "composite",
  "requests": [
    {
      "stream": [
        {
          "name": "aggs-most-heart-issues-async-submit",
          "operation-type": "submit-async-search",
          "body": {
            "aggs": {
              "0": {
                "terms": {
                  "field": "payload.issue.html_url",
                  "order": {
                    "1": "desc"
                  },
                  "size": 1000
                },
                "aggs": {
                  "1": {
                    "max": {
                      "field": "payload.issue.reactions.heart"
                    }
                  }
                }
              }
            },
            "size": 100,
            "query": {
              "bool": {
                "must": [],
                "filter": [
                  {
                    "range": {
                      "@timestamp": {
                        "format": "strict_date_optional_time",
                        "gte": "2021-09-30T04:00:00.000Z",
                        "lte": "2021-10-11T04:00:00.000Z"
                      }
                    }
                  }
                ],
                "should": [],
                "must_not": []
              }
            }
          },
          "request-params": {
            "wait_for_completion_timeout": "100ms",
            "keep_on_completion": "true"
          }
        },
        {
          "operation-type": "get-async-search",
          "retrieve-results-for": [
            "aggs-most-heart-issues-async-submit"
          ]
        },
        {
          "operation-type": "delete-async-search",
          "delete-results-for": [
            "aggs-most-heart-issues-async-submit"
          ]
        }
      ]
    },
    {
      "stream": [
        {
          "name": "aggs-elastic-top100-async-submit",
          "operation-type": "submit-async-search",
          "body": {
            "aggs": {
              "0": {
                "terms": {
                  "field": "actor.login",
                  "order": {
                    "_count": "desc"
                  },
                  "size": 100
                },
                "aggs": {
                  "1": {
                    "date_histogram": {
                      "field": "@timestamp",
                      "fixed_interval": "3h",
                      "time_zone": "America/Indianapolis",
                      "extended_bounds": {
                        "min": 1632974400000,
                        "max": 1633924800000
                      }
                    }
                  }
                }
              }
            },
            "size": 100,
            "query": {
              "bool": {
                "must": [],
                "filter": [
                  {
                    "match_phrase": {
                      "org.login": "elastic"
                    }
                  },
                  {
                    "range": {
                      "@timestamp": {
                        "format": "strict_date_optional_time",
                        "gte": "2021-09-30T04:00:00.000Z",
                        "lte": "2021-10-11T04:00:00.000Z"
                      }
                    }
                  }
                ],
                "should": [],
                "must_not": []
              }
            }
          },
          "request-params": {
            "wait_for_completion_timeout": "100ms",
            "keep_on_completion": "true"
          }
        },
        {
          "operation-type": "get-async-search",
          "retrieve-results-for": [
            "aggs-elastic-top100-async-submit"
          ]
        },
        {
          "operation-type": "delete-async-search",
          "delete-results-for": [
            "aggs-elastic-top100-async-submit"
          ]
        }
      ]
    },
    {
      "stream": [
        {
          "name": "aggs-repo-activity-async-submit",
          "operation-type": "submit-async-search",
          "body": {
            "aggs": {
              "0": {
                "terms": {
                  "field": "repo.name",
                  "order": {
                    "_count": "desc"
                  },
                  "size": 500
                },
                "aggs": {
                  "1": {
                    "date_histogram": {
                      "field": "created_at",
                      "fixed_interval": "3h",
                      "time_zone": "America/Indianapolis",
                      "extended_bounds": {
                        "min": 1632974400000,
                        "max": 1633924800000
                      }
                    }
                  }
                }
              }
            },
            "size": 10,
            "runtime_mappings": {},
            "_source": {
              "excludes": []
            },
            "query": {
              "bool": {
                "must": [],
                "filter": [
                  {
                    "range": {
                      "created_at": {
                        "format": "strict_date_optional_time",
                        "gte": "2021-09-30T04:00:00.000Z",
                        "lte": "2021-10-11T04:00:00.000Z"
                      }
                    }
                  }
                ],
                "should": [],
                "must_not": []
              }
            }
          },
          "request-params": {
            "wait_for_completion_timeout": "100ms",
            "keep_on_completion": "true"
          }
        },
        {
          "operation-type": "get-async-search",
          "retrieve-results-for": [
            "aggs-repo-activity-async-submit"
          ]
        },
        {
          "operation-type": "delete-async-search",
          "delete-results-for": [
            "aggs-repo-activity-async-submit"
          ]
        }
      ]
    },
    {
      "stream": [
        {
          "name": "aggs-events-by-repo-async-submit",
          "operation-type": "submit-async-search",
          "body": {
            "aggs": {
              "0": {
                "terms": {
                  "field": "type",
                  "order": {
                    "2": "desc"
                  },
                  "size": 200
                },
                "aggs": {
                  "1": {
                    "date_histogram": {
                      "field": "@timestamp",
                      "fixed_interval": "3h",
                      "time_zone": "America/Indianapolis",
                      "extended_bounds": {
                        "min": 1632974400000,
                        "max": 1633924800000
                      }
                    },
                    "aggs": {
                      "2": {
                        "cardinality": {
                          "field": "repo.name"
                        }
                      }
                    }
                  },
                  "2": {
                    "cardinality": {
                      "field": "repo.name"
                    }
                  }
                }
              }
            },
            "size": 10,
            "query": {
              "bool": {
                "must": [],
                "filter": [
                  {
                    "range": {
                      "@timestamp": {
                        "format": "strict_date_optional_time",
                        "gte": "2021-09-30T04:00:00.000Z",
                        "lte": "2021-10-11T04:00:00.000Z"
                      }
                    }
                  }
                ],
                "should": [],
                "must_not": []
              }
            }
          },
          "request-params": {
            "wait_for_completion_timeout": "100ms",
            "keep_on_completion": "true"
          }
        },
        {
          "operation-type": "get-async-search",
          "retrieve-results-for": [
            "aggs-events-by-repo-async-submit"
          ]
        },
        {
          "operation-type": "delete-async-search",
          "delete-results-for": [
            "aggs-events-by-repo-async-submit"
          ]
        }
      ]
    },
    {
      "stream": [
        {
          "name": "aggs-issues-most-reactions",
          "operation-type": "submit-async-search",
          "body": {
            "aggs": {
              "0": {
                "terms": {
                  "field": "payload.issue.html_url",
                  "order": {
                    "1": "desc"
                  },
                  "size": 100
                },
                "aggs": {
                  "1": {
                    "max": {
                      "field": "payload.issue.reactions.total_count"
                    }
                  }
                }
              }
            },
            "size": 10,
            "query": {
              "bool": {
                "must": [],
                "filter": [
                  {
                    "range": {
                      "@timestamp": {
                        "format": "strict_date_optional_time",
                        "gte": "2021-09-30T04:00:00.000Z",
                        "lte": "2021-10-11T04:00:00.000Z"
                      }
                    }
                  }
                ],
                "should": [],
                "must_not": []
              }
            }
          },
          "request-params": {
            "wait_for_completion_timeout": "100ms",
            "keep_on_completion": "true"
          }
        },
        {
          "operation-type": "get-async-search",
          "retrieve-results-for": [
            "aggs-issues-most-reactions"
          ]
        },
        {
          "operation-type": "delete-async-search",
          "delete-results-for": [
            "aggs-issues-most-reactions"
          ]
        }
      ]
    }
  ]
},
{
  "name": "create-transform-group-by-hour",
  "operation-type": "create-transform",
  "transform-id": "transform-group-by-hour",
  "body": {
    "source": {
      "index": [
        "{{ p_index_source }}"
      ],
      "query": {
        "match_all": {}
      }
    },
    "dest": {
      "index": "gha-by-hour"
    },
    "pivot": {
      "group_by": {
        "timestamp": {
          "date_histogram": {
            "field": "created_at",
            "fixed_interval": "1h"
          }
        }
      },
      "aggregations": {
        "count": {
          "value_count": {
            "field": "created_at"
          }
        },
        "issues": {
          "filter": {
            "term": {
              "type": "IssuesEvent"
            }
          }
        },
        "pull_requests": {
          "filter": {
            "term": {
              "type": "PullRequestEvent"
            }
          }
        },
        "active_users": {
          "cardinality": {
            "field": "actor.login"
          }
        }
      }
    },
    "settings": {
      "max_page_search_size": {{max_page_search_size | default(500)}}
    }
  }
},
{
  "name": "create-transform-issue-comments",
  "operation-type": "create-transform",
  "transform-id": "transform-issue-comments",
  "body": {
    "source": {
      "index": [
        "{{ p_index_source }}"
      ],
      "query": {
        "match_all": {}
      }
    },
    "dest": {
      "index": "gha-issue-comments-test"
    },
    "pivot": {
      "group_by": {
        "repo.name": {
          "terms": {
            "field": "repo.name"
          }
        },
        "payload.issue.html_url": {
          "terms": {
            "field": "payload.issue.html_url"
          }
        }
      },
      "aggregations": {
        "payload.comment.id.value_count": {
          "value_count": {
            "field": "payload.comment.id"
          }
        }
      }
    },
    "settings": {
      "max_page_search_size": {{max_page_search_size | default(500)}}
    }
  }
},
{
  "name": "create-transform-repo-commits",
  "operation-type": "create-transform",
  "transform-id": "transform-repo-commits",
  "body": {
    "source": {
      "index": [
        "{{ p_index_source }}"
      ],
      "query": {
        "bool": {
          "should": [
            {
              "match_phrase": {
                "type": "PushEvent"
              }
            }
          ],
          "minimum_should_match": 1
        }
      }
    },
    "dest": {
      "index": "gha-repo-commits"
    },
    "pivot": {
      "group_by": {
        "repo.name": {
          "terms": {
            "field": "repo.name"
          }
        },
        "type": {
          "terms": {
            "field": "type"
          }
        }
      },
      "aggregations": {
         "payload.commits.sha.cardinality": {
          "cardinality": {
            "field": "payload.commits.sha"
          }
        }
      }
    },
    "settings": {
      "max_page_search_size": {{max_page_search_size | default(500)}}
    }
  }
}
