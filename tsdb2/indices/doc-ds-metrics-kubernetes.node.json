{% import "rally.helpers" as rally with context %}

{
  "index_patterns": [
    "k8s*"
  ],
  "data_stream": {},
  "template": {
    "settings": {
      "index": {
        "lifecycle": {
          "name": "metrics"
        },
        "codec": "best_compression",
        "routing": {
          "allocation": {
            "include": {
              "_tier_preference": "data_hot"
            }
          }
        },
        "mapping": {
          "total_fields": {
            "limit": "10000"
          }
        },
        "query": {
          "default_field": [
            "cloud.account.id",
            "cloud.availability_zone",
            "cloud.instance.id",
            "cloud.instance.name",
            "cloud.machine.type",
            "cloud.provider",
            "cloud.region",
            "cloud.project.id",
            "cloud.image.id",
            "container.id",
            "container.image.name",
            "container.name",
            "host.architecture",
            "host.hostname",
            "host.id",
            "host.mac",
            "host.name",
            "host.os.family",
            "host.os.kernel",
            "host.os.name",
            "host.os.platform",
            "host.os.version",
            "host.os.build",
            "host.os.codename",
            "host.type",
            "kubernetes.pod.name",
            "kubernetes.pod.uid",
            "kubernetes.namespace",
            "kubernetes.node.name",
            "kubernetes.node.hostname",
            "kubernetes.replicaset.name",
            "kubernetes.deployment.name",
            "kubernetes.statefulset.name",
            "kubernetes.container.name",
            "kubernetes.container.image",
            "ecs.version",
            "service.address",
            "service.type",
            "orchestrator.cluster.name",
            "orchestrator.cluster.url"
          ]
        },
        "mode": "{{index_mode | default('time_series')}}",
          {% if index_mode | default('time_series') is equalto 'time_series' %}
          "routing_path": [
            "kubernetes.namespace",
            "kubernetes.namespace_uid",
            "kubernetes.pod.name",
            "kubernetes.pod.uid"
          ],
          "time_series": {
            "start_time": "2000-01-01T00:00:00Z",
            "end_time": "2099-12-31T23:59:59Z"
          },
          {% endif %}
          "requests.cache.enable": false
      }
    },
    "mappings": {
      "_meta": {
        "managed_by": "fleet",
        "managed": true,
        "package": {
          "name": "kubernetes"
        }
      },
      "dynamic_templates": [
        {
          "container.labels": {
            "path_match": "container.labels.*",
            "match_mapping_type": "string",
            "mapping": {
              "type": "keyword"
            }
          }
        },
        {
          "kubernetes.labels.*": {
            "path_match": "kubernetes.labels.*",
            "mapping": {
              "type": "keyword"
            }
          }
        },
        {
          "kubernetes.annotations.*": {
            "path_match": "kubernetes.annotations.*",
            "mapping": {
              "type": "keyword"
            }
          }
        },
        {
          "kubernetes.selectors.*": {
            "path_match": "kubernetes.selectors.*",
            "mapping": {
              "type": "keyword"
            }
          }
        },
        {
          "strings_as_keyword": {
            "match_mapping_type": "string",
            "mapping": {
              "ignore_above": 1024,
              "type": "keyword"
            }
          }
        }
      ],
      "date_detection": false,
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        "cloud": {
          "properties": {
            "account": {
              "properties": {
                "id": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "availability_zone": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "image": {
              "properties": {
                "id": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "instance": {
              "properties": {
                "id": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "machine": {
              "properties": {
                "type": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "project": {
              "properties": {
                "id": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "provider": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "region": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "container": {
          "properties": {
            "id": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "image": {
              "properties": {
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "name": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "data_stream": {
          "properties": {
            "dataset": {
              "type": "constant_keyword"
            },
            "namespace": {
              "type": "constant_keyword"
            },
            "type": {
              "type": "constant_keyword"
            }
          }
        },
        "ecs": {
          "properties": {
            "version": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "event": {
          "properties": {
            "agent_id_status": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "ingested": {
              "type": "date",
              "format": "strict_date_time_no_millis||strict_date_optional_time||epoch_millis"
            }
          }
        },
        "host": {
          "properties": {
            "architecture": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "containerized": {
              "type": "boolean"
            },
            "domain": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "hostname": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "id": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "ip": {
              "type": "ip"
            },
            "mac": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "name": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "os": {
              "properties": {
                "build": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "codename": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "family": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "kernel": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024,
                  "fields": {
                    "text": {
                      "type": "text"
                    }
                  }
                },
                "platform": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "version": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "type": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        },
        "kubernetes": {
          "properties": {
            "container": {
              "properties": {
                "image": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "deployment": {
              "properties": {
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "namespace": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "node": {
              "properties": {
                "cpu": {
                  "properties": {
                    "usage": {
                      "properties": {
                        "core": {
                          "properties": {
                            "ns": {
                              "type": "long",
                              "meta": {
                                "metric_type": "gauge"
                              }
                            }
                          }
                        },
                        "nanocores": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge"
                          }
                        }
                      }
                    }
                  }
                },
                "fs": {
                  "properties": {
                    "available": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    },
                    "capacity": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    },
                    "inodes": {
                      "properties": {
                        "count": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge"
                          }
                        },
                        "free": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge"
                          }
                        },
                        "used": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge"
                          }
                        }
                      }
                    },
                    "used": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    }
                  }
                },
                "hostname": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "memory": {
                  "properties": {
                    "available": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    },
                    "majorpagefaults": {
                      "type": "long",
                      "meta": {
                        "metric_type": "counter"
                      }
                    },
                    "pagefaults": {
                      "type": "long",
                      "meta": {
                        "metric_type": "counter"
                      }
                    },
                    "rss": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    },
                    "usage": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    },
                    "workingset": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "gauge",
                            "unit": "byte"
                          }
                        }
                      }
                    }
                  }
                },
                "name": {
                  "type": "keyword",
                  "time_series_dimension": true
                },
                "network": {
                  "properties": {
                    "rx": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "counter",
                            "unit": "byte"
                          }
                        },
                        "errors": {
                          "type": "long"
                        }
                      }
                    },
                    "tx": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "meta": {
                            "metric_type": "counter",
                            "unit": "byte"
                          }
                        },
                        "errors": {
                          "type": "long",
                          "meta": {
                            "metric_type": "counter"
                          }
                        }
                      }
                    }
                  }
                },
                "runtime": {
                  "properties": {
                    "imagefs": {
                      "properties": {
                        "available": {
                          "properties": {
                            "bytes": {
                              "type": "long",
                              "meta": {
                                "metric_type": "gauge",
                                "unit": "byte"
                              }
                            }
                          }
                        },
                        "capacity": {
                          "properties": {
                            "bytes": {
                              "type": "long",
                              "meta": {
                                "metric_type": "gauge",
                                "unit": "byte"
                              }
                            }
                          }
                        },
                        "used": {
                          "properties": {
                            "bytes": {
                              "type": "long",
                              "meta": {
                                "metric_type": "gauge",
                                "unit": "byte"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "start_time": {
                  "type": "date"
                }
              }
            },
            "pod": {
              "properties": {
                "ip": {
                  "type": "ip"
                },
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "uid": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "replicaset": {
              "properties": {
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            },
            "statefulset": {
              "properties": {
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            }
          }
        },
        "orchestrator": {
          "properties": {
            "cluster": {
              "properties": {
                "name": {
                  "type": "keyword",
                  "ignore_above": 1024
                },
                "url": {
                  "type": "keyword",
                  "ignore_above": 1024
                }
              }
            }
          }
        },
        "service": {
          "properties": {
            "address": {
              "type": "keyword",
              "ignore_above": 1024
            },
            "type": {
              "type": "keyword",
              "ignore_above": 1024
            }
          }
        }
      }
    },
    "aliases": {}
  }
}