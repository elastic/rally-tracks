{%- if ingest_mode is defined and ingest_mode == "data_stream" %}
    {%- set p_index_source = 'gharchive' %}
{%- else %}
    {%- set p_index_source = 'github-archive' %}
{%- endif %}
{%- set p_conflicts = conflicts %}
{%- set p_conflict_probability = conflict_probability | default(25) %}
{%- set p_on_conflict = on_conflict | default('index') %}
{
  "name": "index",
  "operation-type": "bulk",
  "bulk-size": {{bulk_size | default(5000)}},
  "ingest-percentage": {{ingest_percentage | default(100)}}
  {%- if conflicts is defined %},
  "conflicts": "{{p_conflicts}}",
  "on-conflict": "{{p_on_conflict}}",
  "conflict-probability": {{p_conflict_probability}}
  {%- endif %}
},
{
  "name": "default",
  "operation-type": "search",
  "body": {
    "query": {
      "match_all": {}
    }
  }
},
{
  "name": "default_1k",
  "operation-type": "search",
  "body": {
    "query": {
      "match_all": {}
    },
    "size": 1000
  }
},
{
  "name": "bool_query",
  "operation-type": "search",
  "body": {
    "size": 100,
    "query": {
      "bool": {
        "must": [
          {
            "range": {
              "created_at": {
                "lte": "2021-10-01T12:00:00Z",
                "gte": "2021-10-01T00:00:00Z"
              }
            }
          },
          {
            "bool": {
              "should": [
                {
                  "match": {
                    "public": true
                  }
                },
                {
                  "bool": {
                    "must_not": [
                      {
                        "terms": {
                          "type": [
                            "IssueCommentEvent"
                          ]
                        }
                      }
                    ]
                  }
                },
                {
                  "bool": {
                    "should": [
                      {
                        "match": {
                          "payload.action": "opened"
                        }
                      },
                      {
                        "exists": {
                          "field": "org.url"
                        }
                      },
                      {
                        "exists": {
                          "field": "payload.pull_request"
                        }
                      }
                    ]
                  }
                }
              ]
            }
          }
        ],
        "must_not": [
          {
            "match": {
              "has_issues": false
            }
          },
          {
            "bool": {
              "must": [
                {
                  "match": {
                    "repo.visibility": "public"
                  }
                },
                {
                  "bool": {
                    "should": [
                      {
                        "match": {
                          "pull_request.state": "open"
                        }
                      },
                      {
                        "bool": {
                          "must_not": [
                            {
                              "exists":{
                                "field": "pull_request.merged_at"
                              }
                            }
                          ]
                        }
                      }
                    ],
                    "minimum_should_match": 1
                  }
                }
              ]
            }
          }
        ]
      }
    }
  }
}
